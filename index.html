<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Guru Modern</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: { primary: '#4f46e5', secondary: '#6366f1' }
        }
      }
    }
  </script>

  <style>
    body { background-color: #f8fafc; }
    .glass-card { @apply bg-white border border-gray-200 shadow-sm rounded-2xl overflow-hidden; }
    .sidebar-item { @apply flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium text-gray-600 hover:bg-indigo-50 hover:text-primary; }
    .sidebar-active { @apply bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:text-white; }
    .input-field { @apply w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:bg-white outline-none transition-all; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    
    #toast-container { @apply fixed top-5 right-5 z-[100] flex flex-col gap-3; }
    .toast { @apply flex items-center p-4 rounded-xl shadow-2xl border-l-4 min-w-[300px] bg-white animate-slide-in; }
    @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body class="text-slate-900">

  <div id="toast-container"></div>

  <div id="loginPage" class="min-h-screen flex items-center justify-center p-6 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-100 via-slate-50 to-white">
    <div class="w-full max-w-md">
      <div class="text-center mb-10">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-primary text-white rounded-3xl shadow-xl shadow-indigo-200 mb-6">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A10.003 10.003 0 0012 21a10.003 10.003 0 008.384-4.562l.054.09m-9.928-10.29A9 9 0 0012 3a9 9 0 008.834 5.13M12 11V3m0 8l4 4m-4-4l-4 4"/></svg>
        </div>
        <h1 class="text-3xl font-extrabold tracking-tight">Presensi Guru</h1>
        <p class="text-slate-500 mt-2">Silahkan masuk untuk akses absensi</p>
      </div>

      <div class="glass-card p-8 bg-white/80 backdrop-blur-xl">
        <div class="space-y-5">
          <div>
            <label class="block text-sm font-semibold mb-2 ml-1">Username</label>
            <input id="username" type="text" class="input-field" placeholder="Masukkan username">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2 ml-1">Password</label>
            <div class="relative">
              <input id="password" type="password" class="input-field" placeholder="••••••••">
              <button onclick="togglePassword()" class="absolute right-4 top-3.5 text-gray-400 hover:text-primary">
                <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              </button>
            </div>
          </div>
          <button onclick="login()" id="btnLogin" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2">
            Masuk Sekarang
          </button>
          <p id="loginMsg" class="text-center text-sm text-red-500 font-medium h-2"></p>
        </div>
      </div>
    </div>
  </div>

  <div id="mainApp" class="hidden min-h-screen flex flex-col lg:flex-row">
    <aside class="w-full lg:w-72 bg-white border-r border-gray-100 flex flex-col sticky top-0 h-auto lg:h-screen z-50">
      <div class="p-6 flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <span class="text-xl font-bold tracking-tight text-indigo-900">EduPresence</span>
      </div>

      <nav class="flex-1 px-4 space-y-2 overflow-y-auto pb-6">
        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 ml-4 mt-4">Menu Utama</div>
        
        <button onclick="showPage('dashboard')" id="btn-dashboard" class="sidebar-item w-full hidden">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2v-4zM14 16a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2v-4z"/></svg>
          Dashboard Admin
        </button>

        <button onclick="showPage('absensi')" id="btn-absensi" class="sidebar-item w-full sidebar-active">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Halaman Absen
        </button>

        <button onclick="showPage('rekap')" id="btn-rekap" class="sidebar-item w-full">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
          Riwayat & Grafik
        </button>

        <button onclick="showPage('manager')" id="btn-manager" class="sidebar-item w-full hidden">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          Manajemen User
        </button>
      </nav>

      <div class="p-4 border-t border-gray-100">
        <div class="bg-slate-50 rounded-2xl p-4 mb-4">
          <p class="text-xs font-bold text-slate-400 uppercase mb-2">User Aktif</p>
          <p id="userName" class="font-bold text-slate-800 truncate"></p>
        </div>
        <button onclick="logout()" class="flex items-center gap-3 w-full px-4 py-3 text-red-500 font-semibold hover:bg-red-50 rounded-xl transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          Keluar Sistem
        </button>
      </div>
    </aside>

    <main class="flex-1 p-4 lg:p-8 overflow-y-auto h-screen">
      
      <section id="dashboard" class="hidden animate-in fade-in duration-500">
        <h2 class="text-2xl font-bold mb-6">Ringkasan Kehadiran</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="glass-card p-6 border-l-4 border-l-indigo-600">
            <p class="text-slate-500 font-medium">Hadir Hari Ini</p>
            <div class="flex items-end gap-2 mt-2">
              <span id="hariIni" class="text-4xl font-black text-slate-800">0</span>
              <span class="text-slate-400 mb-1">Guru</span>
            </div>
          </div>
          <div class="glass-card p-6 border-l-4 border-l-emerald-500">
            <p class="text-slate-500 font-medium">Total Absensi Bulan Ini</p>
            <div class="flex items-end gap-2 mt-2">
              <span id="bulanIni" class="text-4xl font-black text-slate-800">0</span>
              <span class="text-slate-400 mb-1">Entri</span>
            </div>
          </div>
        </div>
      </section>

      <section id="absensi" class="max-w-4xl mx-auto py-10">
        <div class="text-center mb-10">
          <h2 class="text-3xl font-bold text-slate-800">Presensi Harian</h2>
          <p id="todayDate" class="text-indigo-600 font-semibold mt-2 text-lg"></p>
        </div>

        <div class="glass-card p-10 text-center relative overflow-hidden bg-white">
          <div class="absolute top-0 right-0 p-4 opacity-5">
            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/></svg>
          </div>

          <div class="relative z-10">
            <button id="btnAbsen" onclick="doAbsen()" class="group relative inline-flex items-center justify-center w-48 h-48 bg-indigo-600 rounded-full text-white shadow-2xl shadow-indigo-200 hover:scale-105 transition-all duration-300 active:scale-95">
              <div class="absolute inset-0 rounded-full bg-indigo-600 animate-ping opacity-20"></div>
              <div class="flex flex-col items-center">
                <svg class="w-16 h-16 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3 3m0 0l-3-3m3 3V8m0 13a9 9 0 110-18 9 9 0 010 18z"/></svg>
                <span class="font-bold text-lg">KLIK ABSEN</span>
              </div>
            </button>
            <p id="absenMsg" class="mt-8 text-lg font-medium text-slate-600"></p>
          </div>
          
          <div class="mt-12 pt-8 border-t border-dashed border-slate-200">
            <div class="flex justify-around items-center">
              <div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Kehadiran Anda</p>
                <p class="text-3xl font-black text-indigo-600"><span id="totalBulan">0</span> Hari</p>
              </div>
              <div class="h-10 w-[1px] bg-slate-200"></div>
              <p class="text-sm text-slate-500 max-w-[200px] text-left">Rekap otomatis periode 26 s/d 25 setiap bulannya.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="rekap" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Analitik & Riwayat</h2>
        
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <div class="xl:col-span-2 glass-card p-6">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span class="w-2 h-6 bg-indigo-600 rounded-full"></span>
              Grafik Kehadiran Harian
            </h3>
            <div class="h-[300px]">
              <canvas id="attendanceChart"></canvas>
            </div>
          </div>

          <div class="glass-card">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold">Aktivitas Terbaru</h3>
            </div>
            <div class="overflow-y-auto max-h-[400px]">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 sticky top-0">
                  <tr>
                    <th class="p-3 text-left">Nama</th>
                    <th class="p-3 text-left">Waktu</th>
                  </tr>
                </thead>
                <tbody id="rekapTable" class="divide-y divide-slate-50"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="manager" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-slate-800">Manajemen Pengguna</h2>
        </div>
        <div class="glass-card">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="p-4 text-left font-semibold text-slate-600">Informasi User</th>
                  <th class="p-4 text-left font-semibold text-slate-600">Keamanan</th>
                  <th class="p-4 text-left font-semibold text-slate-600">Otoritas</th>
                  <th class="p-4 text-center font-semibold text-slate-600">Tindakan</th>
                </tr>
              </thead>
              <tbody id="userTable" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
// KONFIGURASI API
const API_URL = 'https://script.google.com/macros/s/AKfycbx01WEQHO7bIt0bU0Km3IyJ50ZDw5VaAJoJEic7Yg95WS9vpkPxUIYPbVEdD0nSFqxqEQ/exec';

let currentUser = JSON.parse(localStorage.getItem('absensiUser')) || null;
let chartInstance = null;

// UTILS
const formatDate = (date) => date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

function showToast(msg, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const borderCol = type === 'success' ? 'border-emerald-500' : 'border-red-500';
  const iconCol = type === 'success' ? 'text-emerald-500' : 'text-red-500';
  
  toast.className = `toast ${borderCol}`;
  toast.innerHTML = `
    <div class="${iconCol} mr-3">
      ${type === 'success' ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>' : '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/></svg>'}
    </div>
    <div class="text-slate-700 font-semibold">${msg}</div>
  `;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3500);
}

async function apiCall(action, params = {}, method = 'GET') {
  let url = `${API_URL}?action=${action}`;
  if (method === 'GET') {
    Object.keys(params).forEach(key => url += `&${key}=${encodeURIComponent(params[key])}`);
  }
  const options = { method };
  if (method === 'POST') {
    options.body = JSON.stringify({ action, ...params });
  }
  try {
    const res = await fetch(url, options);
    return await res.json();
  } catch (e) {
    showToast("Gagal terhubung ke server!", "error");
    return { success: false };
  }
}

// AUTH FUNCTIONS
async function login() {
  const userInp = document.getElementById('username');
  const passInp = document.getElementById('password');
  const btn = document.getElementById('btnLogin');
  
  if (!userInp.value || !passInp.value) {
    document.getElementById('loginMsg').textContent = "Input tidak boleh kosong!";
    return;
  }

  btn.disabled = true;
  btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Memverifikasi...`;

  const result = await apiCall('login', { username: userInp.value.trim(), password: passInp.value });
  
  if (result.success) {
    currentUser = result;
    localStorage.setItem('absensiUser', JSON.stringify(currentUser));
    initApp();
  } else {
    document.getElementById('loginMsg').textContent = "Username/Password salah!";
    btn.disabled = false;
    btn.innerHTML = "Masuk Sekarang";
  }
}

function logout() {
  localStorage.removeItem('absensiUser');
  location.reload();
}

function togglePassword() {
  const pass = document.getElementById('password');
  pass.type = pass.type === 'password' ? 'text' : 'password';
}

// CORE APP LOGIC
function showPage(pageId) {
  ['dashboard', 'absensi', 'rekap', 'manager'].forEach(p => {
    document.getElementById(p).classList.add('hidden');
    const btn = document.getElementById(`btn-${p}`);
    if(btn) btn.classList.remove('sidebar-active');
  });

  document.getElementById(pageId).classList.remove('hidden');
  const activeBtn = document.getElementById(`btn-${pageId}`);
  if(activeBtn) activeBtn.classList.add('sidebar-active');
}

async function doAbsen() {
  const btn = document.getElementById('btnAbsen');
  btn.disabled = true;
  
  const today = new Date().toISOString().split('T')[0];
  const result = await apiCall('absen', { nama: currentUser.nama, tanggal: today }, 'POST');

  if (result.success) {
    showToast("Absensi berhasil disimpan!", "success");
    loadAbsensi();
    loadRekap();
  } else {
    showToast(result.message || "Gagal absen!", "error");
  }
  btn.disabled = false;
}

async function initApp() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('userName').textContent = currentUser.nama;
  document.getElementById('todayDate').textContent = formatDate(new Date());

  if (currentUser.role === 'admin') {
    document.getElementById('btn-dashboard').classList.remove('hidden');
    document.getElementById('btn-manager').classList.remove('hidden');
    showPage('dashboard');
    loadDashboard();
    loadUsers();
  } else {
    showPage('absensi');
  }

  loadAbsensi();
  loadRekap();
  loadChart();
}

// API DATA LOADING
async function loadAbsensi() {
  const data = await apiCall('getAbsensiUser', { nama: currentUser.nama });
  // Logika filter tanggal 26 - 25
  const count = data.length; // Sederhanakan atau sesuaikan logika bulan
  document.getElementById('totalBulan').textContent = count;
}

async function loadRekap() {
  const data = await apiCall('getAllAbsensi');
  const tbody = document.getElementById('rekapTable');
  tbody.innerHTML = data.slice(0, 10).map(row => `
    <tr class="hover:bg-slate-50 transition">
      <td class="p-3 font-semibold text-slate-700">${row.nama}</td>
      <td class="p-3 text-slate-500">${row.waktu}</td>
    </tr>
  `).join('');
}

async function loadDashboard() {
  const data = await apiCall('getAllAbsensi');
  const today = new Date().toISOString().split('T')[0];
  const countToday = data.filter(r => r.tanggal === today).length;
  document.getElementById('hariIni').textContent = countToday;
  document.getElementById('bulanIni').textContent = data.length;
}

async function loadChart() {
  const ctx = document.getElementById('attendanceChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'],
      datasets: [{
        label: 'Kehadiran Guru',
        data: [12, 19, 15, 17, 14, 5],
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79, 70, 229, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

async function loadUsers() {
  const data = await apiCall('getAllUsers');
  const tbody = document.getElementById('userTable');
  tbody.innerHTML = data.map((user, idx) => `
    <tr>
      <td class="p-4">
        <input class="input-field py-2 text-sm" value="${user.nama}">
        <input class="input-field py-2 text-sm mt-2 text-gray-500" value="${user.username}">
      </td>
      <td class="p-4">
        <input type="password" class="input-field py-2 text-sm" placeholder="Password baru">
      </td>
      <td class="p-4">
        <select class="input-field py-2 text-sm">
          <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
          <option value="guru" ${user.role==='guru'?'selected':''}>Guru</option>
        </select>
      </td>
      <td class="p-4 text-center">
        <button onclick="saveUser(${user.row}, this)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700">
          Simpan
        </button>
      </td>
    </tr>
  `).join('');
}

async function saveUser(row, btn) {
  const tr = btn.closest('tr');
  const inputs = tr.querySelectorAll('input');
  const select = tr.querySelector('select');
  
  const payload = {
    row: row,
    nama: inputs[0].value,
    username: inputs[1].value,
    password: inputs[2].value,
    role: select.value
  };

  btn.innerText = "Processing...";
  const res = await apiCall('updateUser', payload, 'POST');
  if(res.success) showToast("Data berhasil diupdate!");
  btn.innerText = "Simpan";
}

// BOOTSTRAP
if (currentUser) initApp();
</script>
</body>
</html>
