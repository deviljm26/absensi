<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduPresence - Absensi Guru Premium</title>

  <!-- Font Satoshi (Premium Modern Font) -->
  <link href="https://api.fonts.coollabs.io/css2?family=Satoshi:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Satoshi', 'system-ui', 'sans-serif'],
          },
          colors: {
            primary: '#6366f1',
            accent: '#8b5cf6',
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #f0f5ff 0%, #e0eaff 50%, #f5e8ff 100%);
      min-height: 100vh;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.5rem;
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.1);
    }
    .btn-absen {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      transition: all 0.4s ease;
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
    }
    .btn-absen:hover:not(:disabled) {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 30px 60px rgba(99, 102, 241, 0.4);
    }
    .btn-absen:active {
      transform: translateY(-4px) scale(1.02);
    }
    .btn-absen:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }
    .pulse-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.3);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.6; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .sidebar-item {
      transition: all 0.3s ease;
    }
    .sidebar-item:hover {
      background: rgba(99, 102, 241, 0.1);
      transform: translateX(8px);
    }
    .sidebar-active {
      background: linear-gradient(to right, #6366f1, #8b5cf6);
      color: white !important;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
    }
    #toast-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 100;
    }
    .toast {
      min-width: 350px;
      padding: 1.2rem 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideIn 0.5s ease;
      margin-bottom: 1rem;
    }
    .toast.success { background: linear-gradient(to right, #10b981, #059669); color: white; }
    .toast.error { background: linear-gradient(to right, #ef4444, #dc2626); color: white; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- Toast -->
  <div id="toast-container"></div>

  <!-- Login Page -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center p-6">
    <div class="glass-card w-full max-w-lg p-12">
      <div class="text-center mb-12">
        <div class="w-24 h-24 bg-gradient-to-br from-primary to-accent rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
          <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/>
          </svg>
        </div>
        <h1 class="text-4xl font-black mb-2">EduPresence</h1>
        <p class="text-gray-600 text-lg">Sistem Absensi Guru Premium</p>
      </div>

      <div class="space-y-8">
        <div>
          <label class="block text-sm font-bold mb-3 text-gray-700">Username</label>
          <input id="username" type="text" class="w-full px-6 py-5 bg-white/80 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary text-lg transition" placeholder="Masukkan username">
        </div>
        <div>
          <label class="block text-sm font-bold mb-3 text-gray-700">Password</label>
          <div class="relative">
            <input id="password" type="password" class="w-full px-6 py-5 bg-white/80 border border-gray-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-primary/30 focus:border-primary pr-16 text-lg transition" placeholder="••••••••">
            <button type="button" onclick="togglePassword()" class="absolute right-6 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary">
              <svg id="eye-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
        </div>

        <button onclick="login()" class="w-full btn-absen text-white font-black py-5 rounded-2xl shadow-2xl flex items-center justify-center gap-4 text-2xl">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l4-4m0 0l-4-4m4 4H3m18 0h-4"/>
          </svg>
          Masuk Sekarang
        </button>
      </div>

      <p id="loginMsg" class="text-center text-red-500 font-bold mt-8 text-lg"></p>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-80 bg-white shadow-2xl flex flex-col">
      <div class="p-8 border-b border-gray-100">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center shadow-xl">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-black">EduPresence</h1>
            <p class="text-gray-500 text-sm">Absensi Premium</p>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-6 space-y-3">
        <button onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-item w-full px-6 py-5 rounded-2xl flex items-center gap-5 text-lg font-semibold text-gray-700 hidden">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Dashboard Admin
        </button>
        <button onclick="showPage('absensi')" id="nav-absensi" class="sidebar-item w-full px-6 py-5 rounded-2xl flex items-center gap-5 text-lg font-semibold sidebar-active">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Halaman Absen
        </button>
        <button onclick="showPage('rekap')" id="nav-rekap" class="sidebar-item w-full px-6 py-5 rounded-2xl flex items-center gap-5 text-lg font-semibold text-gray-700">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10"/>
          </svg>
          Riwayat & Grafik
        </button>
        <button onclick="showPage('manager')" id="nav-manager" class="sidebar-item w-full px-6 py-5 rounded-2xl flex items-center gap-5 text-lg font-semibold text-gray-700 hidden">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Manajemen User
        </button>
      </nav>

      <div class="p-6 border-t border-gray-100">
        <div class="bg-gray-50 rounded-2xl p-5 mb-4">
          <p class="text-sm font-bold text-gray-500 uppercase mb-1">User Aktif</p>
          <p id="userName" class="text-xl font-black text-gray-800"></p>
        </div>
        <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-3 shadow-lg transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Logout
        </button>
      </div>
    </aside>

    <!-- Content -->
    <main class="flex-1 p-8 lg:p-12">
      <!-- Dashboard -->
      <div id="dashboard" class="hidden">
        <h2 class="text-4xl font-black mb-10">Ringkasan Kehadiran</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
          <div class="glass-card p-10 text-center">
            <p class="text-gray-600 text-xl mb-4">Hadir Hari Ini</p>
            <p id="hariIni" class="text-7xl font-black text-primary">0</p>
            <p class="text-gray-500 mt-4">Guru</p>
          </div>
          <div class="glass-card p-10 text-center">
            <p class="text-gray-600 text-xl mb-4">Total Bulan Ini</p>
            <p id="bulanIni" class="text-7xl font-black text-primary">0</p>
            <p class="text-gray-500 mt-4">Entri</p>
          </div>
        </div>
      </div>

      <!-- Absensi -->
      <div id="absensi">
        <div class="text-center mb-16">
          <h2 class="text-5xl font-black text-gray-800">Presensi Harian</h2>
          <p id="todayDate" class="text-3xl text-primary font-bold mt-4"></p>
        </div>

        <div class="glass-card max-w-4xl mx-auto p-16 text-center">
          <div class="relative inline-block">
            <div class="pulse-ring"></div>
            <button id="btnAbsen" onclick="doAbsen()" class="btn-absen text-white w-80 h-80 rounded-full flex flex-col items-center justify-center gap-8 shadow-2xl relative">
              <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-3xl font-black">KLIK ABSEN</span>
            </button>
          </div>

          <p id="absenMsg" class="mt-12 text-2xl font-medium"></p>

          <div class="mt-16 pt-12 border-t-4 border-dashed border-gray-200">
            <p class="text-gray-600 text-xl mb-4">Total Kehadiran Bulan Ini</p>
            <p class="text-7xl font-black text-primary"><span id="totalBulan">0</span></p>
            <p class="text-gray-500 mt-6 text-lg">(Periode: 26 bulan lalu — 25 hari ini)</p>
          </div>
        </div>
      </div>

      <!-- Rekap -->
      <div id="rekap" class="hidden">
        <h2 class="text-4xl font-black mb-10">Riwayat & Grafik</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
          <div class="lg:col-span-2 glass-card p-10">
            <h3 class="text-2xl font-bold mb-8">Grafik Kehadiran Bulan Ini</h3>
            <canvas id="attendanceChart" height="300"></canvas>
          </div>
          <div class="glass-card p-8">
            <h3 class="text-2xl font-bold mb-8">Absen Terbaru</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
              <table class="w-full" id="rekapTable"></table>
            </div>
          </div>
        </div>
      </div>

      <!-- Manager -->
      <div id="manager" class="hidden">
        <h2 class="text-4xl font-black mb-10">Manajemen Pengguna</h2>
        <div class="glass-card overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-8 text-left text-lg font-bold">Nama</th>
                <th class="p-8 text-left text-lg font-bold">Username</th>
                <th class="p-8 text-left text-lg font-bold">Password Baru</th>
                <th class="p-8 text-left text-lg font-bold">Role</th>
                <th class="p-8 text-center text-lg font-bold">Aksi</th>
              </tr>
            </thead>
            <tbody id="userTable"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

<script>
// GANTI DENGAN URL WEB APP ANDA!
const API_URL = 'https://script.google.com/macros/s/AKfycbx01WEQHO7bIt0bU0Km3IyJ50ZDw5VaAJoJEic7Yg95WS9vpkPxUIYPbVEdD0nSFqxqEQ/exec';

let currentUser = JSON.parse(localStorage.getItem('absensiUser')) || null;
let chartInstance = null;

function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="${type === 'success' ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}"/>
    </svg>
    <span class="text-xl font-bold">${message}</span>
  `;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

function togglePassword() {
  const input = document.getElementById('password');
  const icon = document.getElementById('eye-icon');
  if (input.type === 'password') {
    input.type = 'text';
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.97 9.97 0 011.952-3.055M6.118 6.118L3 9m3.118-3.118L9 3m5.882 15.882L21 21m-3.118-3.118L15 21m-5.882-2.118A3 3 0 119 12a3 3 0 013.882 5.882"/>';
  } else {
    input.type = 'password';
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
  }
}

async function apiCall(action, params = {}, method = 'GET') {
  let url = `${API_URL}?action=${action}`;
  if (method === 'GET' && Object.keys(params).length) {
    Object.keys(params).forEach(k => url += `&${k}=${encodeURIComponent(params[k])}`);
  }

  const options = { method };
  if (method === 'POST') {
    options.headers = { 'Content-Type': 'application/json' };
    options.body = JSON.stringify({ action, ...params });
  }

  try {
    const response = await fetch(url, options);
    const text = await response.text();
    try {
      return JSON.parse(text);
    } catch (e) {
      console.error('Response not JSON:', text);
      showToast('Error server response', 'error');
      return { success: false };
    }
  } catch (error) {
    console.error('Fetch error:', error);
    showToast('Tidak dapat terhubung ke server', 'error');
    return { success: false };
  }
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const btn = document.getElementById('btnLogin');
  const msg = document.getElementById('loginMsg');

  if (!username || !password) {
    msg.textContent = 'Username dan password wajib diisi!';
    return;
  }

  btn.disabled = true;
  btn.innerHTML = 'Memproses...';

  const result = await apiCall('login', { username, password }, 'POST');

  btn.disabled = false;
  btn.innerHTML = 'Masuk Sekarang';

  if (result && result.success) {
    currentUser = result;
    localStorage.setItem('absensiUser', JSON.stringify(currentUser));
    showToast(`Selamat datang, ${currentUser.nama}!`, 'success');
    initApp();
  } else {
    msg.textContent = result?.message || 'Username atau password salah!';
  }
}

function logout() {
  if (confirm('Yakin ingin keluar?')) {
    localStorage.removeItem('absensiUser');
    currentUser = null;
    location.reload();
  }
}

function showPage(page) {
  document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
  document.getElementById(page).classList.remove('hidden');

  document.querySelectorAll('#sidebar button[id^="nav-"]').forEach(btn => btn.classList.remove('sidebar-active'));
  const activeBtn = document.getElementById(`nav-${page}`);
  if (activeBtn) activeBtn.classList.add('sidebar-active');
}

async function checkTodayAttendance() {
  const data = await apiCall('getAbsensiUser', { nama: currentUser.nama });
  const today = new Date().toISOString().split('T')[0];
  const todayRecord = data.find(r => r.tanggal === today);

  const btn = document.getElementById('btnAbsen');
  const text = btn.querySelector('span');
  const msg = document.getElementById('absenMsg');

  if (todayRecord) {
    btn.disabled = true;
    text.textContent = 'SUDAH ABSEN';
    msg.textContent = 'Terima kasih! Absensi Anda sudah tercatat hari ini.';
    msg.className = 'mt-12 text-2xl font-bold text-green-600';
  } else {
    btn.disabled = false;
    text.textContent = 'KLIK ABSEN';
    msg.textContent = '';
  }
}

async function doAbsen() {
  const btn = document.getElementById('btnAbsen');
  btn.disabled = true;
  const today = new Date().toISOString().split('T')[0];

  const result = await apiCall('absen', { nama: currentUser.nama, tanggal: today }, 'POST');

  if (result.success) {
    showToast('Absen berhasil tercatat!', 'success');
    await checkTodayAttendance();
    await loadAbsensi();
    if (currentUser.role === 'admin') await loadDashboard();
    await loadRekap();
    await loadChart();
  } else {
    showToast(result.message || 'Sudah absen hari ini!', 'error');
    btn.disabled = false;
  }
}

async function loadAbsensi() {
  const data = await apiCall('getAbsensiUser', { nama: currentUser.nama });
  const range = getMonthRange();
  const count = data.filter(r => r.tanggal >= range.start && r.tanggal <= range.end).length;
  document.getElementById('totalBulan').textContent = count;
}

async function loadRekap() {
  const data = await apiCall('getAllAbsensi');
  const tbody = document.getElementById('rekapTable');
  tbody.innerHTML = '';
  data.slice(0, 10).reverse().forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-6 font-bold text-lg">${row.nama}</td>
      <td class="p-6 text-gray-600 text-lg">${row.waktu || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadDashboard() {
  const data = await apiCall('getAllAbsensi');
  const today = new Date().toISOString().split('T')[0];
  const range = getMonthRange();
  const todayCount = data.filter(r => r.tanggal === today).length;
  const monthCount = data.filter(r => r.tanggal >= range.start && r.tanggal <= range.end).length;
  document.getElementById('hariIni').textContent = todayCount;
  document.getElementById('bulanIni').textContent = monthCount;
}

async function loadChart() {
  const data = await apiCall('getAllAbsensi');
  const range = getMonthRange();
  const daily = {};
  data.forEach(r => {
    if (r.tanggal >= range.start && r.tanggal <= range.end) {
      daily[r.tanggal] = (daily[r.tanggal] || 0) + 1;
    }
  });
  const labels = [];
  const values = [];
  let curr = new Date(range.start);
  const end = new Date(range.end);
  while (curr <= end) {
    const key = curr.toISOString().split('T')[0];
    labels.push(curr.getDate());
    values.push(daily[key] || 0);
    curr.setDate(curr.getDate() + 1);
  }

  const ctx = document.getElementById('attendanceChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Jumlah Hadir',
        data: values,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 8,
        pointHoverRadius: 12,
        pointBackgroundColor: '#6366f1',
        pointBorderColor: '#fff',
        pointBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

async function loadUsers() {
  const data = await apiCall('getAllUsers');
  const tbody = document.getElementById('userTable');
  tbody.innerHTML = data.map(u => `
    <tr class="hover:bg-gray-50">
      <td class="p-8"><input value="${u.nama}" class="w-full px-6 py-4 border rounded-2xl text-lg"></td>
      <td class="p-8"><input value="${u.username}" class="w-full px-6 py-4 border rounded-2xl text-lg"></td>
      <td class="p-8"><input type="password" placeholder="Kosongkan jika tidak ubah" class="w-full px-6 py-4 border rounded-2xl text-lg"></td>
      <td class="p-8">
        <select class="w-full px-6 py-4 border rounded-2xl text-lg">
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
          <option value="guru" ${u.role==='guru'?'selected':''}>Guru</option>
        </select>
      </td>
      <td class="p-8 text-center">
        <button onclick="saveUser(${u.row}, this)" class="bg-gradient-to-r from-primary to-accent text-white px-10 py-5 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transition">
          Simpan
        </button>
      </td>
    </tr>
  `).join('');
}

async function saveUser(row, btn) {
  const tr = btn.closest('tr');
  const inputs = tr.querySelectorAll('input');
  const select = tr.querySelector('select');
  const payload = {
    row,
    nama: inputs[0].value.trim(),
    username: inputs[1].value.trim(),
    role: select.value
  };
  if (inputs[2].value) payload.password = inputs[2].value;

  btn.disabled = true;
  btn.textContent = 'Menyimpan...';
  const res = await apiCall('updateUser', payload, 'POST');
  btn.disabled = false;
  btn.textContent = 'Simpan';
  showToast(res.success ? 'Berhasil disimpan!' : 'Gagal menyimpan', res.success ? 'success' : 'error');
}

function getMonthRange() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const start = new Date(year, month - 1, 26);
  const end = new Date(year, month, 25);
  return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
}

function initApp() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('userName').textContent = currentUser.nama;
  document.getElementById('todayDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

  if (currentUser.role === 'admin') {
    document.querySelectorAll('#nav-dashboard, #nav-manager').forEach(el => el.classList.remove('hidden'));
    showPage('dashboard');
    loadDashboard();
    loadUsers();
  } else {
    showPage('absensi');
  }

  checkTodayAttendance();
  loadAbsensi();
  loadRekap();
  loadChart();
}

if (currentUser) {
  initApp();
}
</script>

</body>
</html>
